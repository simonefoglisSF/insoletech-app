<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1c20">
    <title>InsoleTech | Biometric Case Study</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- RESET & BASE --- */
        :root {
            --bg-color: #1a1c20;
            --text-color: #ffffff;
            --accent-blue: #0047AB;
            --accent-green: #10b981;
            --accent-cyan: #00f2ff;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --dim-color: #9ca3af;
            --card-bg: #25282e;
            --font-main: 'Inter', sans-serif;
            --nav-height: 60px; /* Ridotto per mobile */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            overflow-x: hidden;
            overflow-y: auto;
            padding-top: var(--nav-height);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER & NAVIGAZIONE --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--nav-height);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; 
            background: rgba(26, 28, 32, 0.98);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .brand-area { display: flex; align-items: center; }
        .logo { font-weight: 800; font-size: 1.1rem; text-decoration: none; color: white; letter-spacing: 0.5px; }

        .header-controls { display: flex; align-items: center; gap: 8px; }
        
        .status-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; transition: 0.3s; margin-right: 5px; }
        
        .session-timer { 
            font-family: monospace; font-size: 0.85rem; color: var(--accent-cyan); 
            display: none; /* Nascosto su mobile di default per spazio */
        }

        /* Pulsanti Header Ottimizzati */
        .ctrl-btn {
            border: 1px solid rgba(255,255,255,0.2); background: transparent; color: white;
            padding: 8px 12px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border-radius: 6px;
        }
        .btn-connect { background: var(--accent-blue); border-color: var(--accent-blue); }
        .btn-reset { background: #333; }

        /* --- LAYOUT MOBILE FIRST --- */
        .view-section { width: 100%; height: 100%; display: none; }
        .view-section.active-view { display: block; }

        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            padding-bottom: 80px; /* Spazio per scroll fondo */
            max-width: 100%;
            margin: 0 auto;
        }

        /* --- CARDS --- */
        .card { 
            background: var(--card-bg); 
            border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 16px; 
            overflow: hidden; 
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Visualizzatore P5 */
        #p5-container { 
            width: 100%; 
            height: 45vh; /* Occupa quasi met√† schermo verticale */
            min-height: 300px;
            background: #000; 
            display: flex; justify-content: center; align-items: center; 
        }

        .alert-overlay { 
            position: absolute; top: 10px; right: 10px; left: 10px; text-align: center;
            background: rgba(239, 68, 68, 0.9); color: white; 
            padding: 8px; font-weight: 700; font-size: 0.8rem; 
            display: none; border-radius: 8px; animation: pulse 1s infinite; pointer-events: none;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Sidebar diventa sotto-sezione */
        .sidebar { display: flex; flex-direction: column; gap: 15px; width: 100%; }

        .control-panel, .data-panel { 
            padding: 15px; 
            background: var(--card-bg); 
            border-radius: 12px; 
        }

        /* --- TABELLA E DATI --- */
        h3 { font-size: 0.85rem; color: #888; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }

        .btn-action {
            width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; margin-bottom: 10px; cursor: pointer; border: none;
        }
        #btn-snapshot { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); border: 1px solid var(--accent-green); }
        #btn-export { background: #333; color: #ccc; border: 1px solid #555; }

        .compare-table { width: 100%; font-size: 0.9rem; border-collapse: collapse; text-align: center; }
        .compare-table th { color: #888; padding-bottom: 5px; border-bottom: 1px solid #444; font-size: 0.8rem;}
        .compare-table td { padding: 8px 0; border-bottom: 1px solid #333; font-family: monospace; font-size: 1rem; }
        .diff-pos { color: var(--accent-green); } .diff-neg { color: #ff4444; }

        /* --- SENSORI --- */
        .sensor-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); 
        }
        .sensor-info h4 { font-size: 0.9rem; margin-bottom: 2px; }
        .sensor-info span { font-size: 0.7rem; color: #666; }

        .led-wrapper { display: flex; align-items: center; gap: 10px; }
        .sensor-val { font-family: monospace; font-size: 1.1rem; min-width: 40px; text-align: right; color: var(--accent-cyan); }
        .led-bulb { width: 12px; height: 12px; border-radius: 50%; background-color: #333; border: 1px solid #444; }

        /* Grafico Live */
        #liveChartContainer { height: 180px; padding: 5px; }

        /* --- MEDIA QUERY TABLET/DESKTOP (Ripristina layout se schermo grande) --- */
        @media (min-width: 900px) {
            .dashboard { 
                display: grid; grid-template-columns: 1fr 380px; 
                height: calc(100vh - 80px); overflow: hidden; 
            }
            .sidebar { height: 100%; overflow-y: auto; }
            #p5-container { height: 100%; }
            .session-timer { display: block; }
            .nav-menu { display: flex; } /* Ripristina menu se c'era */
        }
    </style>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Err:', err));
            });
        }
    </script>
</head>
<body>

    <header>
        <div class="brand-area">
            <a href="#" class="logo">INSOLE.TECH</a>
        </div>
        
        <div class="header-controls">
            <div id="status-dot" class="status-dot"></div>
            <div id="session-timer" class="session-timer">00:00:00</div>
            
            <button id="resetBtn" class="ctrl-btn btn-reset">‚Ü∫</button>
            <button id="pauseBtn" class="ctrl-btn btn-reset">II</button>
            <button id="connectBtn" class="ctrl-btn btn-connect">CONNECT</button>
        </div>
    </header>

    <div id="view-lab" class="view-section active-view">
        <section class="dashboard">
            
            <div class="card">
                <div id="p5-container"></div>
                <div id="alert-box" class="alert-overlay">‚ö†Ô∏è POSTURA SBILANCIATA</div>
            </div>

            <div class="sidebar">
                
                <div class="card data-panel">
                    <h3>Live Feedback</h3>
                    <div class="sensor-row">
                        <div class="sensor-info"><h4>RETRO</h4><span>Pin A0 ‚Ä¢ Blu</span></div>
                        <div class="led-wrapper"><div class="sensor-val" id="val-r">0</div><div class="led-bulb" id="led-r"></div></div>
                    </div>
                    <div class="sensor-row">
                        <div class="sensor-info"><h4>MESO</h4><span>Pin A1 ‚Ä¢ Rosso</span></div>
                        <div class="led-wrapper"><div class="sensor-val" id="val-m">0</div><div class="led-bulb" id="led-m"></div></div>
                    </div>
                    <div class="sensor-row">
                        <div class="sensor-info"><h4>AVAMP</h4><span>Pin A2 ‚Ä¢ Verde</span></div>
                        <div class="led-wrapper"><div class="sensor-val" id="val-a">0</div><div class="led-bulb" id="led-a"></div></div>
                    </div>
                </div>

                <div class="card" id="liveChartContainer">
                    <canvas id="liveChart"></canvas>
                </div>

                <div class="control-panel card">
                    <h3>Analisi Clinica</h3>
                    <button id="btn-snapshot" class="btn-action">üì∑ SALVA BASELINE</button>
                    
                    <table class="compare-table">
                        <thead><tr><th>Zona</th><th>Pre</th><th>Live</th><th>Œî%</th></tr></thead>
                        <tbody>
                            <tr><td>Retro</td><td id="pre-r">--</td><td id="live-r">0</td><td id="diff-r">--</td></tr>
                            <tr><td>Meso</td><td id="pre-m">--</td><td id="live-m">0</td><td id="diff-m">--</td></tr>
                            <tr><td>Avamp</td><td id="pre-a">--</td><td id="live-a">0</td><td id="diff-a">--</td></tr>
                        </tbody>
                    </table>
                    
                    <button id="btn-export" class="btn-action" style="margin-top:15px;">‚¨áÔ∏è EXPORT CSV</button>
                </div>

            </div>
        </section>
    </div>

    <script>
        // --- LOGICA ORIGINALE ---
        function switchView(viewId, btnElement) {
            // (Funzione mantenuta per compatibilit√†, anche se ora c'√® solo una vista)
            if(viewId === 'view-lab') windowResized();
        }

        let r = 0, m = 0, a = 0;
        let smoothX = 0, smoothY = 0;
        let trace = [];
        let savedR = 0, savedM = 0, savedA = 0, isSaved = false;
        let sessionData = [], startTime, timerInterval;
        let isConnected = false, isPaused = false;
        let port, reader, readableStreamClosed;

        function setup() { 
            let container = document.getElementById('p5-container'); 
            // Usa le dimensioni del contenitore CSS
            let cnv = createCanvas(container.offsetWidth, container.offsetHeight); 
            cnv.parent('p5-container'); 
            imageMode(CENTER); 
            smooth(); 
        }

        function windowResized() { 
            let container = document.getElementById('p5-container'); 
            if(container) resizeCanvas(container.offsetWidth, container.offsetHeight); 
        }

        function draw() {
            clear(); push(); translate(width/2, height/2);
            
            // Scala adattiva per mobile
            let sFactor = width < 400 ? 1.2 : 1.7;
            scale(sFactor);

            stroke(255, 30); strokeWeight(2); noFill();
            beginShape(); vertex(-30, -140); bezierVertex(-10, -160, 40, -150, 60, -110); bezierVertex(70, -50, 70, 50, 50, 150); bezierVertex(30, 180, -20, 180, -40, 150); bezierVertex(-30, 100, -10, 50, -40, 0); bezierVertex(-60, -50, -50, -100, -30, -140); endShape(CLOSE);
            
            drawSensor(5, 150, r, [0, 100, 255]); 
            drawSensor(40, 0, m, [255, 50, 50]); 
            drawSensor(-20, -120, a, [50, 255, 100]); 
            
            let total = r + m + a;
            if (total > 50) {
                let x = ((r * 5) + (m * 40) + (a * -20)) / total; let y = ((r * 150) + (m * 0) + (a * -120)) / total;
                smoothX = lerp(smoothX, x, 0.1); smoothY = lerp(smoothY, y, 0.1);
                trace.push({x: smoothX, y: smoothY}); if(trace.length > 40) trace.shift();
                noFill(); stroke(255, 255, 255, 150); strokeWeight(3); beginShape(); trace.forEach(p => vertex(p.x, p.y)); endShape();
                noStroke(); fill(255); ellipse(smoothX, smoothY, 15, 15); fill(255, 50); ellipse(smoothX, smoothY, 30, 30);
                let alertBox = document.getElementById('alert-box');
                if(Math.abs(smoothX) > 40) alertBox.style.display = 'block'; else alertBox.style.display = 'none';
            }
            pop(); updateDOM();
        }

        function drawSensor(x, y, val, colorRGB) { 
            let size = map(val, 0, 800, 40, 280); 
            let alpha = map(val, 0, 800, 50, 220); 
            size = constrain(size, 40, 300); alpha = constrain(alpha, 50, 255); 
            noStroke(); fill(colorRGB[0], colorRGB[1], colorRGB[2], alpha); ellipse(x, y, size); 
            fill(255, 200); ellipse(x, y, 15); 
        }

        function updateDOM() { document.getElementById('val-r').innerText = r; document.getElementById('live-r').innerText = r; document.getElementById('val-m').innerText = m; document.getElementById('live-m').innerText = m; document.getElementById('val-a').innerText = a; document.getElementById('live-a').innerText = a; updateLedStyle('led-r', r, '0, 100, 255'); updateLedStyle('led-m', m, '255, 50, 50'); updateLedStyle('led-a', a, '50, 255, 100'); if(isSaved) updateComparison(); }
        function updateLedStyle(id, val, rgbString) { let el = document.getElementById(id); let intensity = map(val, 0, 800, 0, 1); if (intensity > 0.1) { el.style.backgroundColor = `rgb(${rgbString})`; el.style.boxShadow = `0 0 ${intensity * 25}px rgba(${rgbString}, 0.9)`; el.style.opacity = 1; } else { el.style.backgroundColor = '#222'; el.style.boxShadow = 'none'; el.style.opacity = 0.5; } }
        function updateComparison() { calcDiff('diff-r', savedR, r); calcDiff('diff-m', savedM, m); calcDiff('diff-a', savedA, a); }
        function calcDiff(id, base, current) { let el = document.getElementById(id); let diff = 0; if(base > 0) diff = ((current - base) / base) * 100; else if(current > 0) diff = 100; el.innerText = (diff > 0 ? "+" : "") + diff.toFixed(0) + "%"; el.className = diff >= 0 ? "diff-pos" : "diff-neg"; }

        const ctx = document.getElementById('liveChart').getContext('2d');
        const chart = new Chart(ctx, { type: 'line', data: { labels: Array(30).fill(''), datasets: [ { label: 'R Live', data: [], borderColor: '#0064ff', borderWidth: 2, pointRadius: 0, tension: 0.4 }, { label: 'M Live', data: [], borderColor: '#ff3232', borderWidth: 2, pointRadius: 0, tension: 0.4 }, { label: 'A Live', data: [], borderColor: '#32ff64', borderWidth: 2, pointRadius: 0, tension: 0.4 }, { label: 'R Pre', data: [], borderColor: '#0064ff', borderDash: [5,5], borderWidth: 1, pointRadius: 0, hidden: true }, { label: 'M Pre', data: [], borderColor: '#ff3232', borderDash: [5,5], borderWidth: 1, pointRadius: 0, hidden: true }, { label: 'A Pre', data: [], borderColor: '#32ff64', borderDash: [5,5], borderWidth: 1, pointRadius: 0, hidden: true } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#222' }, min: 0, max: 800 } }, animation: false } });

        document.getElementById('btn-snapshot').addEventListener('click', () => { savedR = r; savedM = m; savedA = a; isSaved = true; document.getElementById('pre-r').innerText = savedR; document.getElementById('pre-m').innerText = savedM; document.getElementById('pre-a').innerText = savedA; chart.data.datasets[3].data = [...chart.data.datasets[0].data]; chart.data.datasets[4].data = [...chart.data.datasets[1].data]; chart.data.datasets[5].data = [...chart.data.datasets[2].data]; chart.data.datasets[3].hidden = false; chart.data.datasets[4].hidden = false; chart.data.datasets[5].hidden = false; chart.update(); });
        document.getElementById('btn-export').addEventListener('click', () => { if (sessionData.length === 0) { alert("Nessun dato."); return; } let csv = "data:text/csv;charset=utf-8,Time,Retropiede,Mesopiede,Avampiede\n" + sessionData.map(e => `${e.t},${e.r},${e.m},${e.a}`).join("\n"); let link = document.createElement("a"); link.href = encodeURI(csv); link.download = "insole_data.csv"; link.click(); });
        document.getElementById('resetBtn').addEventListener('click', () => { clearInterval(timerInterval); document.getElementById('session-timer').innerText = "00:00:00"; startTime = null; sessionData = []; trace = []; chart.data.datasets.forEach(ds => ds.data = []); chart.data.datasets[3].hidden = true; chart.data.datasets[4].hidden = true; chart.data.datasets[5].hidden = true; chart.update(); isSaved = false; savedR=0; savedM=0; savedA=0; document.getElementById('pre-r').innerText = "--"; document.getElementById('pre-m').innerText = "--"; document.getElementById('pre-a').innerText = "--"; if (isConnected) startTimer(); });
        document.getElementById('pauseBtn').addEventListener('click', () => { isPaused = !isPaused; let btn = document.getElementById('pauseBtn'); if(isPaused) { btn.innerText = "‚ñ∫"; btn.style.color = "black"; btn.style.backgroundColor = "var(--accent-yellow)"; } else { btn.innerText = "II"; btn.style.color = "var(--accent-yellow)"; btn.style.backgroundColor = "transparent"; } });

        function startTimer() { startTime = Date.now(); document.getElementById('session-timer').style.display = 'block'; document.getElementById('status-dot').style.background = '#00ff00'; document.getElementById('status-dot').style.boxShadow = '0 0 10px #00ff00'; timerInterval = setInterval(() => { let d = new Date(Date.now() - startTime); document.getElementById('session-timer').innerText = d.toISOString().substr(14, 9); }, 50); }
        function parseArduinoString(str) { if (isPaused) return; const rM = str.match(/Retropiede:(\d+)/), mM = str.match(/Mesopiede:(\d+)/), aM = str.match(/Avampiede:(\d+)/); if (rM && mM && aM) { r = parseInt(rM[1]); m = parseInt(mM[1]); a = parseInt(aM[1]); if (startTime) sessionData.push({ t: Date.now() - startTime, r, m, a }); chart.data.datasets[0].data.push(r); chart.data.datasets[1].data.push(m); chart.data.datasets[2].data.push(a); if(chart.data.datasets[0].data.length > 30) { chart.data.datasets[0].data.shift(); chart.data.datasets[1].data.shift(); chart.data.datasets[2].data.shift(); if(isSaved) { chart.data.datasets[3].data.shift(); chart.data.datasets[4].data.shift(); chart.data.datasets[5].data.shift(); } } chart.update('none'); } }
        
        document.getElementById('connectBtn').addEventListener('click', async () => {
            if (isConnected) { if(reader) { await reader.cancel(); await readableStreamClosed.catch(()=>{}); } if(port) await port.close(); isConnected = false; clearInterval(timerInterval); document.getElementById('status-dot').style.background = '#ff4444'; document.getElementById('connectBtn').innerText = "CONNECT"; return; }
            if ("serial" in navigator) { try { port = await navigator.serial.requestPort(); await port.open({ baudRate: 9600 }); isConnected = true; startTimer(); document.getElementById('connectBtn').innerText = "DISCONNECT";  const textDecoder = new TextDecoderStream(); readableStreamClosed = port.readable.pipeTo(textDecoder.writable); reader = textDecoder.readable.getReader(); let buffer = ""; while (true) { const { value, done } = await reader.read(); if (done) break; buffer += value; let lines = buffer.split('\n'); for (let i = 0; i < lines.length - 1; i++) parseArduinoString(lines[i]); buffer = lines[lines.length - 1]; } } catch (e) { console.error(e); alert("Errore di connessione."); isConnected = false; } } else { alert("Browser non supportato."); }
        });
    </script>
</body>
</html>
