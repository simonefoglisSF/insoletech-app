<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Insole.Pro - Analisi Statica Professionale</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F8FAFC;
            --card: #FFFFFF;
            --primary: #2563EB;
            --success: #10B981;
            --danger: #EF4444;
            --text-main: #1E293B;
            --text-muted: #64748B;
            --border: #E2E8F0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text-main); padding-top: 80px; padding-bottom: 40px; }

        header {
            position: fixed; top: 0; width: 100%; height: 70px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 1000;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 0 15px; }
        
        .card {
            background: var(--card); border-radius: 24px;
            border: 1px solid var(--border); margin-bottom: 20px;
            overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }

        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 0.9rem; color: var(--text-muted); }

        #p5-container { width: 100%; height: 420px; background: #fff; position: relative; }

        /* Controlli Timer e Test */
        .test-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        button { padding: 12px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        
        .btn-mode { background: var(--bg); color: var(--text-muted); border: 2px solid var(--border); }
        .btn-mode.active { border-color: var(--primary); color: var(--primary); background: rgba(37,99,235,0.05); }
        
        .btn-main { background: var(--primary); color: white; width: 100%; height: 50px; font-size: 1rem; }
        .btn-main:disabled { background: var(--border); cursor: not-allowed; }

        #timer-display { font-size: 3rem; font-weight: 800; color: var(--primary); text-align: center; margin: 10px 0; display: none; }

        /* Report Area */
        .report-area { padding: 20px; display: none; background: #fdfdfd; }
        .comp-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        .comp-table th { text-align: left; color: var(--text-muted); font-size: 0.75rem; padding-bottom: 10px; }
        .comp-table td { padding: 12px 0; border-top: 1px solid var(--border); font-weight: 600; }

        .badge-diff { padding: 4px 8px; border-radius: 8px; font-size: 0.8rem; }
        .diff-pos { background: #fee2e2; color: var(--danger); }
        .diff-neg { background: #dcfce7; color: var(--success); }

        .stat-val { font-size: 1.4rem; font-weight: 800; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid var(--border); }
        .stat-item { padding: 15px; text-align: center; border-right: 1px solid var(--border); }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; flex-direction: column;">
            <span style="font-weight: 800; color: var(--primary);">INSOLE.PRO</span>
            <span id="usb-status" style="font-size: 0.6rem; color: var(--danger);">‚óè DISCONNESSO (USB-C)</span>
        </div>
        <button id="connectBtn" class="btn-main" style="width: auto; height: 40px; padding: 0 15px; font-size: 0.8rem;">CONNETTI</button>
    </header>

    <div class="container">
        
        <div class="card">
            <div class="card-header">MAPPA STATICA E BARICENTRO (CoP)</div>
            <div id="p5-container"></div>
            <div class="stats-grid">
                <div class="stat-item"><span style="font-size: 0.7rem; color: var(--text-muted);">RETRO</span><span class="stat-val" id="val-r" style="color: #3b82f6;">0</span></div>
                <div class="stat-item"><span style="font-size: 0.7rem; color: var(--text-muted);">MESO</span><span class="stat-val" id="val-m" style="color: #ef4444;">0</span></div>
                <div class="stat-item"><span style="font-size: 0.7rem; color: var(--text-muted);">AVAMP</span><span class="stat-val" id="val-a" style="color: #10b981;">0</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">PROTOCOLLO DI TEST (10 SECONDI)</div>
            <div class="test-controls">
                <button id="mode-a" class="btn-mode active">SENZA PLANTARE</button>
                <button id="mode-b" class="btn-mode">CON PLANTARE</button>
            </div>
            <div style="padding: 15px;">
                <div id="timer-display">10s</div>
                <button id="recordBtn" class="btn-main">AVVIA TEST STATICO</button>
            </div>
        </div>

        <div id="report-section" class="card report-area">
            <h2 style="font-size: 1.1rem; margin-bottom: 10px;">Referto Analisi Comparativa</h2>
            <div id="comparison-content">
                </div>
            <button id="pdfBtn" class="btn-main" style="margin-top: 20px; background: #000;">üìÑ SCARICA REFERTO PDF</button>
        </div>

    </div>

    <script>
        let r = 0, m = 0, a = 0;
        let isConnected = false, isRecording = false;
        let currentMode = 'A';
        let baseline = null, comparison = null;
        let sessionData = { r: [], m: [], a: [] };
        let port, reader;
        let timeLeft = 10;
        let countdown;

        // --- P5.JS: GRAFICA E HEATMAP ---
        function setup() {
            let container = document.getElementById('p5-container');
            let cnv = createCanvas(container.offsetWidth, container.offsetHeight);
            cnv.parent('p5-container');
        }

        function draw() {
            clear();
            translate(width/2, height/2);
            scale(min(width, height) / 420);

            // Sagoma Piede
            stroke('#E2E8F0'); strokeWeight(3); noFill();
            drawFootOutline();

            // Heatmap Sensori
            drawHeatPoint(10, 130, r, [59, 130, 246]);   
            drawHeatPoint(35, 0, m, [239, 68, 68]);     
            drawHeatPoint(-15, -135, a, [16, 185, 129]); 

            // Baricentro (CoP)
            let cop = calculateCOP(r, m, a);
            if((r+m+a) > 30) {
                // CoP Attuale
                fill(37, 99, 235); noStroke();
                ellipse(cop.x, cop.y, 14, 14);
                
                // Se c'√® Baseline, mostra vettore spostamento
                if(baseline) {
                    let bCop = calculateCOP(baseline.r, baseline.m, baseline.a);
                    stroke(100, 116, 139, 100); line(bCop.x, bCop.y, cop.x, cop.y);
                    fill(100, 116, 139, 150); ellipse(bCop.x, bCop.y, 10, 10);
                }
            }
            updateLabels();
        }

        function drawFootOutline() {
            beginShape();
            vertex(-30, -165); bezierVertex(-10, -185, 50, -175, 75, -135);
            bezierVertex(85, -75, 85, 55, 60, 155); bezierVertex(40, 190, -20, 190, -45, 155);
            bezierVertex(-35, 110, -15, 60, -50, 0); bezierVertex(-75, -60, -60, -125, -30, -165);
            endShape(CLOSE);
        }

        function drawHeatPoint(x, y, val, rgb) {
            let radius = map(val, 0, 1023, 20, 180);
            for(let i = radius; i > 0; i -= 15) {
                fill(rgb[0], rgb[1], rgb[2], map(i, 0, radius, 150, 0));
                noStroke(); ellipse(x, y, i);
            }
        }

        function calculateCOP(rv, mv, av) {
            let total = rv + mv + av || 1;
            return {
                x: ((rv * 10) + (mv * 35) + (av * -15)) / total,
                y: ((rv * 130) + (mv * 0) + (av * -135)) / total
            };
        }

        // --- SERIALE USB-C ---
        document.getElementById('connectBtn').onclick = async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                isConnected = true;
                document.getElementById('usb-status').innerText = "‚óè CONNETTO (USB-C)";
                document.getElementById('usb-status').style.color = "var(--success)";
                readUSB();
            } catch (e) { console.log("Connessione annullata"); }
        };

        async function readUSB() {
            const decoder = new TextDecoderStream();
            port.readable.pipeTo(decoder.writable);
            reader = decoder.readable.getReader();
            let buffer = "";
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += value;
                let lines = buffer.split('\n');
                for (let i = 0; i < lines.length - 1; i++) {
                    let mR = lines[i].match(/Retropiede:(\d+)/);
                    let mM = lines[i].match(/Mesopiede:(\d+)/);
                    let mA = lines[i].match(/Avampiede:(\d+)/);
                    if(mR && mM && mA) {
                        r = parseInt(mR[1]); m = parseInt(mM[1]); a = parseInt(mA[1]);
                        if(isRecording) {
                            sessionData.r.push(r); sessionData.m.push(m); sessionData.a.push(a);
                        }
                    }
                }
                buffer = lines[lines.length - 1];
            }
        }

        // --- GESTIONE TEST E TIMER ---
        document.getElementById('mode-a').onclick = () => switchMode('A');
        document.getElementById('mode-b').onclick = () => switchMode('B');

        function switchMode(m) {
            currentMode = m;
            document.getElementById('mode-a').className = m === 'A' ? 'btn-mode active' : 'btn-mode';
            document.getElementById('mode-b').className = m === 'B' ? 'btn-mode active' : 'btn-mode';
        }

        document.getElementById('recordBtn').onclick = function() {
            if(!isConnected) return alert("Connetti prima la soletta via USB!");
            
            isRecording = true;
            timeLeft = 10;
            sessionData = { r: [], m: [], a: [] };
            
            this.disabled = true;
            const timerDisp = document.getElementById('timer-display');
            timerDisp.style.display = 'block';
            timerDisp.innerText = timeLeft + "s";

            countdown = setInterval(() => {
                timeLeft--;
                timerDisp.innerText = timeLeft + "s";
                if(timeLeft <= 0) stopRecording();
            }, 1000);
        };

        function stopRecording() {
            clearInterval(countdown);
            isRecording = false;
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('timer-display').style.display = 'none';
            
            const avg = arr => Math.round(arr.reduce((a,b)=>a+b, 0) / arr.length);
            let results = { r: avg(sessionData.r), m: avg(sessionData.m), a: avg(sessionData.a) };
            
            if(currentMode === 'A') baseline = results;
            else comparison = results;
            
            renderReport();
        }

        function renderReport() {
            const area = document.getElementById('report-section');
            const content = document.getElementById('comparison-content');
            area.style.display = 'block';
            
            if(!comparison) {
                content.innerHTML = `<p style="color:var(--success); font-weight:600;">‚úÖ Baseline salvata. Ora inserisci il plantare e avvia il secondo test.</p>`;
            } else {
                let dR = ((comparison.r - baseline.r)/baseline.r*100).toFixed(1);
                let dA = ((comparison.a - baseline.a)/baseline.a*100).toFixed(1);
                
                content.innerHTML = `
                    <table class="comp-table">
                        <tr><th>ZONA</th><th>PRE</th><th>POST</th><th>VARIAZIONE</th></tr>
                        <tr><td>Retropiede</td><td>${baseline.r}</td><td>${comparison.r}</td><td><span class="badge-diff ${dR>0?'diff-pos':'diff-neg'}">${dR}%</span></td></tr>
                        <tr><td>Mesopiede</td><td>${baseline.m}</td><td>${comparison.m}</td><td>--</td></tr>
                        <tr><td>Avampiede</td><td>${baseline.a}</td><td>${comparison.a}</td><td><span class="badge-diff ${dA>0?'diff-pos':'diff-neg'}">${dA}%</span></td></tr>
                    </table>
                `;
            }
        }

        // --- PDF GENERATION ---
        document.getElementById('pdfBtn').onclick = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const date = new Date().toLocaleDateString();

            doc.setFont("helvetica", "bold");
            doc.setTextColor(37, 99, 235);
            doc.text("INSOLE.PRO - REFERTO PODOLOGICO", 20, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Data: ${date} | Tipo Analisi: Statica 10s`, 20, 30);
            doc.line(20, 35, 190, 35);

            if(baseline && comparison) {
                doc.setTextColor(0);
                doc.setFontSize(12);
                doc.text("Confronto Distribuzione Pressione:", 20, 50);
                doc.text(`Retro: ${baseline.r} (Pre) -> ${comparison.r} (Post)`, 25, 60);
                doc.text(`Avamp: ${baseline.a} (Pre) -> ${comparison.a} (Post)`, 25, 70);
                
                doc.text("Analisi Biomeccanica:", 20, 90);
                let shift = baseline.a - comparison.a;
                doc.setFont("helvetica", "normal");
                doc.text(shift > 0 ? "- Il plantare ha ridotto correttamente il carico anteriore." : "- Carico anteriore aumentato o invariato.", 20, 100);
            }

            doc.save(`Analisi_InsolePro_${date}.pdf`);
        };

        function updateLabels() {
            document.getElementById('val-r').innerText = r;
            document.getElementById('val-m').innerText = m;
            document.getElementById('val-a').innerText = a;
        }
    </script>
</body>
</html>
